# Java 리플렉션(Reflection) 정리

## 리플렉션이란?

- 런타임에 클래스, 메서드, 필드 등의 정보를 조회하고 조작할 수 있는 기능
- 주요 클래스: `Class`, `Field`, `Method`, `Constructor` (`java.lang.reflect` 패키지)
- 사용 예: 의존성 주입(예: Spring), ORM 매핑(예: Hibernate), 런타임 동적 프록시 등

---

## JPMS를 사용하지 않는 경우 (Java 8 이하 또는 classpath 기반)

- 모든 필드/메서드/생성자에 리플렉션 접근 가능
- `setAccessible(true)` 사용 시 private 필드도 접근 가능(Deep Reflection)
- JVM 인자 없이도 대부분 프레임워크에서 자유롭게 사용 가능

### 예시: private 필드 접근 및 수정

```java
public class User {
    private String name = "initial";
}
```

```java
User user = new User();
Field field = User.class.getDeclaredField("name");
field.setAccessible(true); // private 무시
field.set(user, "modified");

System.out.println(field.get(user)); // "modified"
```

---

## JPMS(Java Platform Module System)를 사용하는 경우 (Java 9 이상, module-info.java 존재)

- 모듈 경계로 인해 리플렉션 접근이 제한됨
- `exports`만으로는 리플렉션 허용 안 됨
- `opens` 키워드를 통해 런타임 리플렉션 허용 필요

### 예시: opens 선언

```java
module com.domain {
    opens com.domain.model to some.framework;
}
```

- `opens`는 리플렉션 용도 (런타임 접근 허용)
- `exports`는 컴파일 시 API 노출 용도
- `to`를 생략하면 모든 모듈에 공개됨

### 예시: 리플렉션 코드 (JPMS에서도 동일)

```java
Field field = User.class.getDeclaredField("name");
field.setAccessible(true);
field.set(user, "modified");
```

#### 단, `opens`가 없으면 다음 예외 발생

```
java.lang.reflect.InaccessibleObjectException: 
Unable to make field private java.lang.String User.name accessible
```

---

## JVM 옵션으로 우회 (권장 X)

빌드 수정 없이 리플렉션 허용하려면 JVM 인자를 사용할 수 있음

```bash
--add-opens com.domain/com.domain.model=ALL-UNNAMED
```

- 특정 모듈의 특정 패키지를 모든 unnamed module에 개방

---

## 비교 요약

| 구분                     | JPMS 미사용                          | JPMS 사용                                  |
|--------------------------|--------------------------------------|---------------------------------------------|
| 리플렉션 기본 동작       | 모든 필드 접근 가능 (`setAccessible`) | 기본적으로 접근 불가                        |
| private 필드 수정        | 가능                                 | `opens` 또는 `--add-opens` 필요             |
| `exports`로 충분한가?    | 예                                   | 아니요 (`opens` 별도 필요)                  |
| JVM 옵션 필요 여부       | 필요 없음                            | 필요 시 `--add-opens` 사용 가능             |
| 보안성                   | 낮음                                 | 높음 (명시적 허용만 접근 가능)              |

---

## 요약

- JPMS 미사용 시 리플렉션은 자유롭고 제한 없음
- JPMS 사용 시 `opens` 또는 JVM 옵션을 통해 접근 허용 필요
- 보안 강화, 모듈 경계 보호 목적
- 프레임워크 호환성을 위해 `opens` + `to` 조합을 권장

